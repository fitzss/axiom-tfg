<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>axiom-tfg</title>
  <style>
    :root { --bg: #0f1117; --card: #1a1d27; --border: #2a2d37; --text: #e0e0e0; --muted: #888; --green: #22c55e; --red: #ef4444; --blue: #3b82f6; --yellow: #eab308; --purple: #a855f7; --orange: #f97316; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace; background: var(--bg); color: var(--text); line-height: 1.6; }
    .container { max-width: 960px; margin: 0 auto; padding: 2rem 1rem; }
    h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .subtitle { color: var(--muted); font-size: 0.85rem; margin-bottom: 2rem; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; margin-bottom: 1.5rem; }
    label { display: block; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
    textarea { width: 100%; min-height: 220px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 0.75rem; font-family: inherit; font-size: 0.85rem; resize: vertical; }
    textarea:focus { outline: none; border-color: var(--blue); }
    input[type="text"], input[type="number"] { background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 0.45rem 0.6rem; font-family: inherit; font-size: 0.8rem; }
    input:focus { outline: none; border-color: var(--blue); }
    select { background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 0.45rem 0.6rem; font-family: inherit; font-size: 0.8rem; }
    select:focus { outline: none; border-color: var(--blue); }
    button { background: var(--blue); color: #fff; border: none; border-radius: 4px; padding: 0.5rem 1.2rem; font-family: inherit; font-size: 0.8rem; cursor: pointer; margin-top: 0.5rem; }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-ai { background: var(--purple); }
    .btn-green { background: var(--green); color: #000; font-weight: bold; }
    .btn-orange { background: var(--orange); color: #000; }
    .btn-sm { padding: 0.3rem 0.7rem; font-size: 0.75rem; margin-top: 0; }
    .btn-red { background: var(--red); }
    .result { margin-top: 1rem; padding: 1rem; border-radius: 4px; display: none; }
    .result.show { display: block; }
    .result.can { background: #0a2612; border: 1px solid var(--green); }
    .result.cant { background: #2a0a0a; border: 1px solid var(--red); }
    .result.err { background: #2a1a0a; border: 1px solid var(--yellow); }
    .verdict { font-size: 1.1rem; font-weight: bold; }
    .verdict.can { color: var(--green); }
    .verdict.cant { color: var(--red); }
    .detail { color: var(--muted); font-size: 0.8rem; margin-top: 0.4rem; }
    .detail a { color: var(--blue); }
    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    th { text-align: left; color: var(--muted); font-weight: normal; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); }
    td { padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); }
    tr:hover { background: rgba(255,255,255,0.02); }
    .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: bold; }
    .badge.can { background: #0a2612; color: var(--green); }
    .badge.cant { background: #2a0a0a; color: var(--red); }
    a { color: var(--blue); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .empty { color: var(--muted); text-align: center; padding: 2rem; }
    .pre-wrap { white-space: pre-wrap; font-size: 0.8rem; margin-top: 0.75rem; max-height: 300px; overflow: auto; background: var(--bg); padding: 0.75rem; border-radius: 4px; }
    .ai-box { margin-top: 0.75rem; padding: 0.75rem; border-radius: 4px; background: #1a1030; border: 1px solid var(--purple); font-size: 0.85rem; display: none; }
    .ai-box.show { display: block; }
    .ai-box .ai-label { font-size: 0.7rem; color: var(--purple); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.3rem; }
    .ai-disabled { color: var(--muted); font-size: 0.75rem; padding: 0.5rem 0.75rem; background: rgba(168,85,247,0.08); border: 1px solid var(--border); border-radius: 4px; margin-top: 0.75rem; }

    /* ── Prompt Mode ── */
    #promptInput { min-height: 80px; }
    #prompt-mode-card textarea:disabled, #prompt-mode-card select:disabled, #prompt-mode-card button:disabled { opacity: 0.4; }

    /* ── Summary Cards ── */
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; }
    .summary-grid .card { margin-bottom: 0; }

    /* ── Task Builder ── */
    .builder-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem 1.25rem; margin-bottom: 0.75rem; }
    .builder-grid .full { grid-column: 1 / -1; }
    .field { display: flex; flex-direction: column; gap: 0.2rem; }
    .field label { margin-bottom: 0; font-size: 0.7rem; }
    .field input, .field select { width: 100%; }
    .xyz-row { display: flex; gap: 0.4rem; }
    .xyz-row input { flex: 1; min-width: 0; }
    .section-title { font-size: 0.75rem; color: var(--blue); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.5rem; margin-bottom: 0.25rem; border-bottom: 1px solid var(--border); padding-bottom: 0.2rem; }
    .section-title:first-child { margin-top: 0; }
    .checkbox-row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; margin-top: 0.25rem; }
    .checkbox-row label { display: inline-flex; align-items: center; gap: 0.3rem; text-transform: none; font-size: 0.8rem; color: var(--text); }
    .zone-row { display: flex; gap: 0.4rem; align-items: end; flex-wrap: wrap; margin-bottom: 0.4rem; }
    .zone-row input { width: 60px; }
    .zone-row .zone-id-input { width: 100px; }

    /* ── Diff viewer ── */
    .diff-panel { margin-top: 0.75rem; display: none; }
    .diff-panel.show { display: block; }
    .diff-toggle { color: var(--blue); cursor: pointer; font-size: 0.8rem; text-decoration: underline; margin-top: 0.5rem; display: inline-block; }
    .diff-content { white-space: pre-wrap; font-size: 0.78rem; background: var(--bg); padding: 0.75rem; border-radius: 4px; margin-top: 0.4rem; max-height: 300px; overflow: auto; }
    .diff-content .diff-del { color: var(--red); }
    .diff-content .diff-add { color: var(--green); }

    /* ── Fix bar ── */
    .fix-bar { margin-top: 0.75rem; padding: 0.75rem; border-radius: 4px; background: #1a1500; border: 1px solid var(--orange); display: none; }
    .fix-bar.show { display: block; }
    .fix-bar .fix-label { font-size: 0.7rem; color: var(--orange); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.3rem; }
    .fix-bar .fix-desc { font-size: 0.8rem; margin-bottom: 0.5rem; }
    .fix-advisory { color: var(--muted); font-size: 0.8rem; font-style: italic; }

    /* ── Sweep ── */
    .sweep-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1rem; margin-bottom: 0.75rem; }
    .sweep-inputs .full { grid-column: 1 / -1; }
    .sweep-range-row { display: flex; gap: 0.4rem; align-items: center; }
    .sweep-range-row label { min-width: 30px; margin-bottom: 0; }
    .sweep-range-row input { width: 80px; }
    .sweep-summary { margin-top: 0.75rem; padding: 0.75rem; border-radius: 4px; background: #0f1a2a; border: 1px solid var(--blue); display: none; }
    .sweep-summary.show { display: block; }
    .sweep-summary .sweep-label { font-size: 0.7rem; color: var(--blue); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .sweep-counts { display: flex; gap: 1.5rem; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .sweep-counts .can-count { color: var(--green); font-weight: bold; }
    .sweep-counts .cant-count { color: var(--red); font-weight: bold; }
    .sweep-tbl { max-height: 280px; overflow: auto; }

    /* ── Advanced toggle ── */
    details#advanced-toggle { margin-bottom: 1.5rem; }
    details#advanced-toggle > summary { list-style: none; cursor: pointer; color: var(--blue); font-size: 0.85rem; margin-bottom: 1rem; user-select: none; }
    details#advanced-toggle > summary::-webkit-details-marker { display: none; }
    details#advanced-toggle > summary::before { content: '+ '; font-weight: bold; }
    details#advanced-toggle[open] > summary::before { content: '- '; }
  </style>
</head>
<body>
<div class="container">
  <h1>axiom-tfg</h1>
  <p class="subtitle">Deterministic physical-task feasibility gate linter</p>

  <!-- ── Prompt Mode ── -->
  <div class="card" id="prompt-mode-card">
    <label for="promptInput">Describe your task
      {% if ai_enabled %}
      <span id="prompt-provider-tag" style="font-size:0.65rem; color:var(--purple); text-transform:none;">({{ ai_status.provider }})</span>
      {% endif %}
      {% if ai_status.provider == 'fallback' %}
      <span class="badge" style="background:#2a1a00;color:var(--orange);margin-left:0.5rem;">Demo Mode</span>
      {% endif %}
    </label>
    {% if ai_status.provider == 'fallback' %}
    <div style="color: var(--orange); font-size: 0.75rem; margin-bottom: 0.5rem;">Demo fallback mode — responses are generated locally (no API key configured).</div>
    {% elif ai_enabled %}
    <div style="color: var(--muted); font-size: 0.75rem; margin-bottom: 0.5rem;">Type a task description, then click Generate + Run. Press Ctrl+Enter for a shortcut.</div>
    {% endif %}
    <textarea id="promptInput" rows="3" spellcheck="false"
      placeholder="e.g. 'Pick a 2kg box from [1,0,1] to [2,1,0.5] with a UR5e'&#10;e.g. 'Move a 0.5kg soda can to [0.8, 0.2, 0.9] using a franka robot'"
      {% if not ai_enabled %}disabled{% endif %}></textarea>
    <div style="display:flex; gap:0.5rem; align-items:end; margin-top:0.5rem;">
      <div class="field" style="flex:0 0 auto;">
        <label>Model</label>
        <select id="ai-model-select" {% if not ai_enabled %}disabled{% endif %}></select>
      </div>
      <button class="btn-ai" id="generateRunBtn" onclick="generateAndRun()" {% if not ai_enabled %}disabled{% endif %}>Generate + Run</button>
    </div>
    {% if not ai_enabled %}
    <div class="ai-disabled">AI disabled: {{ ai_status.reason | default('set GOOGLE_API_KEY or AXIOM_AI_DEMO_FALLBACK=true to enable.') }}</div>
    {% endif %}
    <div id="prompt-status" style="color: var(--muted); font-size: 0.8rem; margin-top: 0.4rem;"></div>
  </div>

  <!-- ── Summary Cards ── -->
  <div id="summary-cards" style="display:none; margin-bottom:1.5rem;">
    <div class="summary-grid">
      <div class="card">
        <label>Robot</label>
        <div id="card-robot-name" style="font-size:1rem; font-weight:bold;"></div>
        <div id="card-robot-detail" style="font-size:0.8rem; color:var(--muted);"></div>
      </div>
      <div class="card">
        <label>Object</label>
        <div id="card-object-name" style="font-size:1rem; font-weight:bold;"></div>
        <div id="card-object-detail" style="font-size:0.8rem; color:var(--muted);"></div>
      </div>
      <div class="card">
        <label>World</label>
        <div id="card-world-name" style="font-size:1rem; font-weight:bold;"></div>
        <div id="card-world-detail" style="font-size:0.8rem; color:var(--muted);"></div>
      </div>
    </div>
  </div>

  <!-- ── Result Display ── -->
  <div id="result" class="result">
    <div id="result-verdict" class="verdict"></div>
    <div id="result-detail" class="detail"></div>

    <!-- Fix bar -->
    <div id="fix-bar" class="fix-bar">
      <div class="fix-label">Counterfactual Fix</div>
      <div id="fix-desc" class="fix-desc"></div>
      <button id="fix-apply-btn" class="btn-orange btn-sm" onclick="applyFix()" style="display:none;">Apply fix to YAML</button>
      <span id="fix-advisory" class="fix-advisory" style="display:none;"></span>
      <div id="diff-panel" class="diff-panel">
        <span class="diff-toggle" onclick="toggleDiff()">Show diff</span>
        <div id="diff-content" class="diff-content" style="display:none;"></div>
      </div>
    </div>

    <div id="ai-explain-box" class="ai-box">
      <div class="ai-label">AI Explanation</div>
      <div id="ai-explain-text"></div>
    </div>
    <div id="result-evidence" class="pre-wrap"></div>
  </div>

  <!-- ── Advanced / Inspect YAML ── -->
  <details id="advanced-toggle">
    <summary>Inspect YAML / Advanced <span style="color:var(--muted); font-size:0.75rem; margin-left:0.5rem;">YAML editor, Task Builder, Load Demo, Sweep</span></summary>

    <!-- ── Load Demo ── -->
    <div class="card">
      <label for="demo-select">Load Demo</label>
      <div style="display:flex; gap:0.5rem; align-items:end;">
        <select id="demo-select" style="flex:1;"><option value="">-- select an example --</option></select>
        <button class="btn-sm" onclick="loadDemo()">Load</button>
      </div>
    </div>

    <!-- ── Task Builder ── -->
    <div class="card">
      <label>Task Builder</label>
      <div class="section-title" style="margin-top:0;">Substrate</div>
      <div class="builder-grid">
        <div class="field"><label>task_id</label><input type="text" id="b-task-id" value="my-task-001"></div>
        <div class="field"><label>substrate.id</label><input type="text" id="b-sub-id" value="soda_can"></div>
        <div class="field"><label>substrate.mass_kg</label><input type="number" id="b-sub-mass" value="0.35" step="0.01" min="0.001"></div>
        <div class="field"><label>substrate.initial_pose.xyz</label><div class="xyz-row"><input type="number" id="b-sub-x" value="1.0" step="0.1"><input type="number" id="b-sub-y" value="0.0" step="0.1"><input type="number" id="b-sub-z" value="0.8" step="0.1"></div></div>
      </div>

      <div class="section-title">Constructor</div>
      <div class="builder-grid">
        <div class="field"><label>constructor.id</label><input type="text" id="b-con-id" value="ur5e"></div>
        <div class="field"><label>constructor.base_pose.xyz</label><div class="xyz-row"><input type="number" id="b-con-x" value="0.0" step="0.1"><input type="number" id="b-con-y" value="0.0" step="0.1"><input type="number" id="b-con-z" value="0.0" step="0.1"></div></div>
        <div class="field"><label>max_reach_m</label><input type="number" id="b-con-reach" value="1.85" step="0.01" min="0.001"></div>
        <div class="field"><label>max_payload_kg</label><input type="number" id="b-con-payload" value="5.0" step="0.1" min="0.001"></div>
      </div>

      <div class="section-title">Transformation</div>
      <div class="builder-grid">
        <div class="field"><label>target_pose.xyz</label><div class="xyz-row"><input type="number" id="b-tgt-x" value="1.2" step="0.1"><input type="number" id="b-tgt-y" value="0.3" step="0.1"><input type="number" id="b-tgt-z" value="0.8" step="0.1"></div></div>
        <div class="field"><label>tolerance_m</label><input type="number" id="b-tgt-tol" value="0.01" step="0.001" min="0.001"></div>
      </div>

      <div class="section-title">Environment</div>
      <div class="builder-grid">
        <div class="field"><label>safety_buffer</label><input type="number" id="b-env-buffer" value="0.02" step="0.01" min="0"></div>
        <div class="field full">
          <label>Keepout zones</label>
          <div id="zone-list"></div>
          <button class="btn-sm" onclick="addZone()">+ Add zone</button>
        </div>
      </div>

      <div class="section-title">Allowed adjustments</div>
      <div class="checkbox-row">
        <label><input type="checkbox" id="b-adj-target" checked> can_move_target</label>
        <label><input type="checkbox" id="b-adj-base"> can_move_base</label>
        <label><input type="checkbox" id="b-adj-constructor"> can_change_constructor</label>
        <label><input type="checkbox" id="b-adj-split"> can_split_payload</label>
      </div>

      <button class="btn-green" onclick="buildYaml()" style="margin-top:0.75rem;">Generate YAML</button>
    </div>

    <!-- ── YAML Editor + Run ── -->
    <div class="card">
      <label for="yaml-input">TaskSpec YAML (source of truth)</label>
      <textarea id="yaml-input" spellcheck="false" placeholder="Paste your TaskSpec YAML here...">task_id: my-task-001
meta:
  template: pick_and_place

substrate:
  id: soda_can
  mass_kg: 0.35
  initial_pose:
    xyz: [1.0, 0.0, 0.8]

transformation:
  target_pose:
    xyz: [1.2, 0.3, 0.8]
  tolerance_m: 0.01

constructor:
  id: ur5e
  base_pose:
    xyz: [0.0, 0.0, 0.0]
  max_reach_m: 1.85
  max_payload_kg: 5.0

allowed_adjustments:
  can_move_target: true
  can_move_base: false
  can_change_constructor: true
  can_split_payload: false</textarea>
      <button id="run-btn" onclick="submitRun()">Run gates</button>
    </div>

    <!-- ── Scenario Sweep ── -->
    <div class="card">
      <label>Scenario Sweep</label>
      <div style="color: var(--muted); font-size: 0.75rem; margin-bottom: 0.5rem;">Generate many variants of the current YAML and run all gates. Results are deterministic by seed.</div>
      <div class="sweep-inputs">
        <div class="field"><label>n (variants)</label><input type="number" id="sw-n" value="20" min="1" max="500"></div>
        <div class="field"><label>seed</label><input type="number" id="sw-seed" value="1337"></div>
        <div class="field full"><div class="section-title" style="margin-top:0;">mass_kg range (optional)</div></div>
        <div class="field"><label>min</label><input type="number" id="sw-mass-min" placeholder="e.g. 0.1" step="0.1"></div>
        <div class="field"><label>max</label><input type="number" id="sw-mass-max" placeholder="e.g. 10.0" step="0.1"></div>
        <div class="field full"><div class="section-title" style="margin-top:0;">target_xyz ranges (optional)</div></div>
        <div class="field"><label>x min</label><input type="number" id="sw-tx-min" placeholder="" step="0.1"></div>
        <div class="field"><label>x max</label><input type="number" id="sw-tx-max" placeholder="" step="0.1"></div>
        <div class="field"><label>y min</label><input type="number" id="sw-ty-min" placeholder="" step="0.1"></div>
        <div class="field"><label>y max</label><input type="number" id="sw-ty-max" placeholder="" step="0.1"></div>
        <div class="field"><label>z min</label><input type="number" id="sw-tz-min" placeholder="" step="0.1"></div>
        <div class="field"><label>z max</label><input type="number" id="sw-tz-max" placeholder="" step="0.1"></div>
      </div>
      <button id="sweep-btn" onclick="runSweep()">Run Sweep</button>
      <div id="sweep-status" style="color: var(--muted); font-size: 0.8rem; margin-top: 0.4rem;"></div>
      <div id="sweep-summary" class="sweep-summary">
        <div class="sweep-label">Sweep Results</div>
        <div id="sweep-counts" class="sweep-counts"></div>
        <div id="sweep-gates" style="font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem;"></div>
        <div id="sweep-link" style="font-size: 0.8rem; margin-bottom: 0.5rem;"></div>
        <div class="sweep-tbl">
          <table>
            <thead><tr><th>Run ID</th><th>Verdict</th><th>Failed gate</th><th></th></tr></thead>
            <tbody id="sweep-runs"></tbody>
          </table>
        </div>
      </div>
    </div>
  </details>

  <!-- ── Recent runs ── -->
  <div class="card">
    <label>Recent runs</label>
    {% if runs %}
    <table>
      <thead>
        <tr>
          <th>Run ID</th>
          <th>Task ID</th>
          <th>Verdict</th>
          <th>Failed gate</th>
          <th>Top fix</th>
          <th>Created</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for r in runs %}
        <tr>
          <td><code>{{ r.run_id }}</code></td>
          <td>{{ r.task_id }}</td>
          <td><span class="badge {{ 'can' if r.verdict == 'CAN' else 'cant' }}">{{ r.verdict }}</span></td>
          <td>{{ r.failed_gate or '-' }}</td>
          <td>{{ r.top_fix or '-' }}</td>
          <td>{{ r.created_at[:19] }}</td>
          <td><a href="/runs/{{ r.run_id }}/evidence" target="_blank">evidence</a></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty">No runs yet. Type a task above and click Generate + Run.</div>
    {% endif %}
  </div>
</div>

<script>
const AI_ENABLED = {{ 'true' if ai_enabled else 'false' }};
const AI_PROVIDER = '{{ ai_status.provider }}';

// ── safe JSON parse helper ──
async function safeJson(resp) {
  const ct = resp.headers.get('content-type') || '';
  if (ct.includes('application/json')) {
    return await resp.json();
  }
  const text = await resp.text();
  try { return JSON.parse(text); } catch (e) { return { detail: text }; }
}

// ── load AI model list ──
async function loadModelList() {
  if (!AI_ENABLED) return;
  try {
    const resp = await fetch('/ai/models');
    const data = await resp.json();
    const sel = document.getElementById('ai-model-select');
    if (!sel) return;
    sel.innerHTML = '';
    (data.models || []).forEach(m => {
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m;
      if (m === data.default) opt.selected = true;
      sel.appendChild(opt);
    });
    if (data.provider === 'fallback') {
      const opt = document.createElement('option');
      opt.value = ''; opt.textContent = 'fallback'; opt.selected = true;
      sel.insertBefore(opt, sel.firstChild);
    }
  } catch (e) { /* ignore */ }
}
loadModelList();

// ── state for fix-apply ──
let _lastYamlBeforeRun = '';
let _pendingFixPatch = null;
let _fixedYaml = '';
let _skipReload = false;

// ── Demo loader ──
async function loadDemoList() {
  try {
    const resp = await fetch('/examples');
    const names = await resp.json();
    const sel = document.getElementById('demo-select');
    names.forEach(n => {
      const opt = document.createElement('option');
      opt.value = n; opt.textContent = n;
      sel.appendChild(opt);
    });
  } catch (e) { /* ignore */ }
}
async function loadDemo() {
  const name = document.getElementById('demo-select').value;
  if (!name) return;
  try {
    const resp = await fetch('/examples/' + encodeURIComponent(name));
    if (resp.ok) {
      document.getElementById('yaml-input').value = await resp.text();
    }
  } catch (e) { /* ignore */ }
}
loadDemoList();

// ── Zone builder ──
let _zoneCount = 0;
function addZone() {
  _zoneCount++;
  const div = document.createElement('div');
  div.className = 'zone-row';
  div.id = 'zone-' + _zoneCount;
  div.innerHTML =
    '<input type="text" class="zone-id-input" placeholder="id" value="zone_' + _zoneCount + '">' +
    '<span style="color:var(--muted);font-size:0.7rem;">min:</span>' +
    '<input type="number" step="0.1" value="0" placeholder="x">' +
    '<input type="number" step="0.1" value="0" placeholder="y">' +
    '<input type="number" step="0.1" value="0" placeholder="z">' +
    '<span style="color:var(--muted);font-size:0.7rem;">max:</span>' +
    '<input type="number" step="0.1" value="1" placeholder="x">' +
    '<input type="number" step="0.1" value="1" placeholder="y">' +
    '<input type="number" step="0.1" value="1" placeholder="z">' +
    '<button class="btn-sm btn-red" onclick="removeZone(' + _zoneCount + ')" style="margin-top:0;">X</button>';
  document.getElementById('zone-list').appendChild(div);
}
function removeZone(id) {
  const el = document.getElementById('zone-' + id);
  if (el) el.remove();
}
function getZones() {
  const zones = [];
  document.querySelectorAll('#zone-list .zone-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    zones.push({
      id: inputs[0].value || 'zone',
      min_xyz: [parseFloat(inputs[1].value)||0, parseFloat(inputs[2].value)||0, parseFloat(inputs[3].value)||0],
      max_xyz: [parseFloat(inputs[4].value)||0, parseFloat(inputs[5].value)||0, parseFloat(inputs[6].value)||0],
    });
  });
  return zones;
}

// ── Build YAML from form ──
function v(id) { return document.getElementById(id).value; }
function n(id) { return parseFloat(document.getElementById(id).value) || 0; }
function c(id) { return document.getElementById(id).checked; }

function buildYaml() {
  let y = '';
  y += 'task_id: ' + v('b-task-id') + '\n';
  y += 'meta:\n  template: pick_and_place\n\n';
  y += 'substrate:\n';
  y += '  id: ' + v('b-sub-id') + '\n';
  y += '  mass_kg: ' + n('b-sub-mass') + '\n';
  y += '  initial_pose:\n    xyz: [' + n('b-sub-x') + ', ' + n('b-sub-y') + ', ' + n('b-sub-z') + ']\n\n';
  y += 'transformation:\n';
  y += '  target_pose:\n    xyz: [' + n('b-tgt-x') + ', ' + n('b-tgt-y') + ', ' + n('b-tgt-z') + ']\n';
  y += '  tolerance_m: ' + n('b-tgt-tol') + '\n\n';
  y += 'constructor:\n';
  y += '  id: ' + v('b-con-id') + '\n';
  y += '  base_pose:\n    xyz: [' + n('b-con-x') + ', ' + n('b-con-y') + ', ' + n('b-con-z') + ']\n';
  y += '  max_reach_m: ' + n('b-con-reach') + '\n';
  y += '  max_payload_kg: ' + n('b-con-payload') + '\n';

  const zones = getZones();
  const buf = n('b-env-buffer');
  if (zones.length > 0 || buf !== 0.02) {
    y += '\nenvironment:\n';
    y += '  safety_buffer: ' + buf + '\n';
    if (zones.length > 0) {
      y += '  keepout_zones:\n';
      zones.forEach(z => {
        y += '    - id: ' + z.id + '\n';
        y += '      min_xyz: [' + z.min_xyz.join(', ') + ']\n';
        y += '      max_xyz: [' + z.max_xyz.join(', ') + ']\n';
      });
    }
  }

  y += '\nallowed_adjustments:\n';
  y += '  can_move_target: ' + c('b-adj-target') + '\n';
  y += '  can_move_base: ' + c('b-adj-base') + '\n';
  y += '  can_change_constructor: ' + c('b-adj-constructor') + '\n';
  y += '  can_split_payload: ' + c('b-adj-split') + '\n';

  document.getElementById('yaml-input').value = y;
}

// ── AI generate (standalone — called by Prompt Mode generateAndRun) ──
async function generateSpec() {
  const btn = document.getElementById('generateRunBtn');
  const prompt = document.getElementById('promptInput').value.trim();
  const status = document.getElementById('prompt-status');
  if (!prompt) { status.textContent = 'Please enter a task description.'; return; }
  btn.disabled = true; btn.textContent = 'Generating...'; status.textContent = '';
  const modelSel = document.getElementById('ai-model-select');
  const model = modelSel && modelSel.value ? modelSel.value : undefined;
  try {
    const body = { prompt };
    if (model) body.model = model;
    const resp = await fetch('/ai/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    const data = await safeJson(resp);
    if (!resp.ok) { status.textContent = 'Error: ' + (data.detail || resp.status); return; }
    document.getElementById('yaml-input').value = data.yaml;
    const via = data.provider === 'fallback' ? ' (fallback)' : ' via ' + (data.model_used || '');
    status.textContent = 'TaskSpec generated' + via + ' — review and click Run gates.';
  } catch (e) { status.textContent = 'Network error: ' + e.message; }
  finally { btn.disabled = false; btn.textContent = 'Generate + Run'; }
}

// ── AI explain ──
async function fetchExplanation(evidence) {
  const box = document.getElementById('ai-explain-box');
  const text = document.getElementById('ai-explain-text');
  box.className = 'ai-box'; text.textContent = '';
  if (!AI_ENABLED) return;
  box.className = 'ai-box show'; text.textContent = 'Thinking...';
  const modelSel = document.getElementById('ai-model-select');
  const model = modelSel && modelSel.value ? modelSel.value : undefined;
  try {
    const body = { evidence };
    if (model) body.model = model;
    const resp = await fetch('/ai/explain', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    const data = await safeJson(resp);
    if (resp.ok) {
      const via = data.provider === 'fallback' ? ' [fallback]' : '';
      text.textContent = data.explanation + via;
    } else {
      text.textContent = 'Error: ' + (data.detail || resp.status);
    }
  } catch (e) { text.textContent = 'Could not get explanation.'; }
}

// ── Apply fix helpers ──
function applyFixToYaml(yamlText, patch) {
  if (!patch || !patch.new_xyz) return yamlText;
  const xyz = patch.new_xyz;
  const xyzStr = '[' + xyz.map(v => parseFloat(v.toFixed(6))).join(', ') + ']';
  const lines = yamlText.split('\n');
  const result = [];

  if (patch.kind === 'MOVE_TARGET') {
    let inTarget = false;
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      if (/^\s*target_pose:/.test(line)) { inTarget = true; result.push(line); continue; }
      if (inTarget && /^\s*xyz:/.test(line)) {
        const indent = line.match(/^(\s*)/)[1];
        result.push(indent + 'xyz: ' + xyzStr);
        inTarget = false; continue;
      }
      if (inTarget && !/^\s/.test(line)) inTarget = false;
      result.push(line);
    }
  } else if (patch.kind === 'MOVE_BASE') {
    let inBase = false;
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      if (/^\s*base_pose:/.test(line)) { inBase = true; result.push(line); continue; }
      if (inBase && /^\s*xyz:/.test(line)) {
        const indent = line.match(/^(\s*)/)[1];
        result.push(indent + 'xyz: ' + xyzStr);
        inBase = false; continue;
      }
      if (inBase && !/^\s/.test(line)) inBase = false;
      result.push(line);
    }
  } else {
    return yamlText;
  }
  return result.join('\n');
}

function computeDiffHtml(before, after) {
  const a = before.split('\n'), b = after.split('\n');
  const maxLen = Math.max(a.length, b.length);
  let html = '';
  for (let i = 0; i < maxLen; i++) {
    const la = i < a.length ? a[i] : undefined;
    const lb = i < b.length ? b[i] : undefined;
    if (la === lb) {
      html += '  ' + esc(la) + '\n';
    } else {
      if (la !== undefined) html += '<span class="diff-del">- ' + esc(la) + '</span>\n';
      if (lb !== undefined) html += '<span class="diff-add">+ ' + esc(lb) + '</span>\n';
    }
  }
  return html;
}
function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function applyFix() {
  if (!_fixedYaml) return;
  document.getElementById('yaml-input').value = _fixedYaml;
  document.getElementById('fix-apply-btn').textContent = 'Applied!';
  document.getElementById('fix-apply-btn').disabled = true;
}

function toggleDiff() {
  const el = document.getElementById('diff-content');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

// ── Summary cards (regex-based YAML parsing) ──
function showSummaryCards(yamlText) {
  try {
    const conIdMatch = yamlText.match(/constructor:\s*\n\s*id:\s*(\S+)/);
    const reachMatch = yamlText.match(/max_reach_m:\s*([\d.]+)/);
    const payloadMatch = yamlText.match(/max_payload_kg:\s*([\d.]+)/);
    document.getElementById('card-robot-name').textContent = conIdMatch ? conIdMatch[1] : '?';
    document.getElementById('card-robot-detail').textContent =
      (reachMatch ? 'reach: ' + reachMatch[1] + 'm' : '') +
      (payloadMatch ? '  payload: ' + payloadMatch[1] + 'kg' : '');

    const subIdMatch = yamlText.match(/substrate:\s*\n\s*id:\s*(\S+)/);
    const massMatch = yamlText.match(/mass_kg:\s*([\d.]+)/);
    document.getElementById('card-object-name').textContent = subIdMatch ? subIdMatch[1] : '?';
    document.getElementById('card-object-detail').textContent = massMatch ? 'mass: ' + massMatch[1] + ' kg' : '';

    const keepoutSection = yamlText.match(/keepout_zones:\s*\n([\s\S]*?)(?:\n\S|\n*$)/);
    const zoneCount = keepoutSection ? (keepoutSection[1].match(/- id:/g) || []).length : 0;
    const bufferMatch = yamlText.match(/safety_buffer:\s*([\d.]+)/);
    document.getElementById('card-world-name').textContent =
      zoneCount > 0 ? zoneCount + ' keepout zone' + (zoneCount > 1 ? 's' : '') : 'No keepout zones';
    document.getElementById('card-world-detail').textContent =
      bufferMatch ? 'safety buffer: ' + bufferMatch[1] + 'm' : 'default buffer';

    document.getElementById('summary-cards').style.display = 'block';
  } catch (e) {
    document.getElementById('summary-cards').style.display = 'none';
  }
}

// ── Submit run ──
async function submitRun() {
  const btn = document.getElementById('run-btn');
  const yamlEl = document.getElementById('yaml-input');
  const yamlText = yamlEl.value;
  _lastYamlBeforeRun = yamlText;
  _pendingFixPatch = null;
  _fixedYaml = '';

  const result = document.getElementById('result');
  const verdict = document.getElementById('result-verdict');
  const detail = document.getElementById('result-detail');
  const evidence = document.getElementById('result-evidence');
  const explainBox = document.getElementById('ai-explain-box');
  const fixBar = document.getElementById('fix-bar');
  const fixDesc = document.getElementById('fix-desc');
  const fixApplyBtn = document.getElementById('fix-apply-btn');
  const fixAdvisory = document.getElementById('fix-advisory');
  const diffPanel = document.getElementById('diff-panel');
  const diffContent = document.getElementById('diff-content');

  btn.disabled = true; btn.textContent = 'Running...';
  result.className = 'result';
  explainBox.className = 'ai-box';
  fixBar.className = 'fix-bar';
  fixApplyBtn.style.display = 'none';
  fixAdvisory.style.display = 'none';
  diffPanel.className = 'diff-panel';
  diffContent.style.display = 'none';

  try {
    const resp = await fetch('/runs', { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: yamlText });
    const data = await safeJson(resp);

    if (!resp.ok) {
      result.className = 'result show err';
      verdict.className = 'verdict cant'; verdict.textContent = 'Error ' + resp.status;
      detail.innerHTML = '<pre>' + JSON.stringify(data.detail, null, 2) + '</pre>';
      evidence.textContent = '';
      return;
    }

    // Show summary cards for the YAML that was run
    showSummaryCards(yamlText);

    const isCan = data.verdict === 'CAN';
    result.className = 'result show ' + (isCan ? 'can' : 'cant');
    verdict.className = 'verdict ' + (isCan ? 'can' : 'cant');
    verdict.textContent = data.verdict;

    let info = 'Run: ' + data.run_id;
    if (data.failed_gate) info += ' | Failed: ' + data.failed_gate;
    if (data.top_fix) info += ' | Fix: ' + data.top_fix;
    info += ' | <a href="' + data.evidence_url + '" target="_blank">View evidence JSON</a>';
    detail.innerHTML = info;
    evidence.textContent = JSON.stringify(data.evidence, null, 2);

    // ── Fix bar ──
    if (!isCan && data.top_fix && data.evidence.counterfactual_fixes && data.evidence.counterfactual_fixes.length > 0) {
      const fix = data.evidence.counterfactual_fixes[0];
      fixBar.className = 'fix-bar show';
      fixDesc.textContent = fix.instruction;

      const patch = data.top_fix_patch;
      if (patch && (patch.kind === 'MOVE_TARGET' || patch.kind === 'MOVE_BASE')) {
        _pendingFixPatch = patch;
        _fixedYaml = applyFixToYaml(_lastYamlBeforeRun, patch);

        fixApplyBtn.style.display = 'inline-block';
        fixApplyBtn.textContent = 'Apply fix to YAML';
        fixApplyBtn.disabled = false;

        diffPanel.className = 'diff-panel show';
        diffContent.innerHTML = computeDiffHtml(_lastYamlBeforeRun, _fixedYaml);
        diffContent.style.display = 'none';
      } else {
        fixAdvisory.textContent = 'Fix is advisory (not auto-applied yet).';
        fixAdvisory.style.display = 'inline';
      }
    }

    // ── AI explain ──
    if (!isCan && AI_ENABLED) { fetchExplanation(data.evidence); }

    // Reload after delay to refresh runs table (skip when called from generateAndRun).
    if (!_skipReload) { setTimeout(() => location.reload(), 2000); }
    _skipReload = false;
  } catch (e) {
    result.className = 'result show err';
    verdict.className = 'verdict cant'; verdict.textContent = 'Network error';
    detail.textContent = e.message; evidence.textContent = '';
  } finally { btn.disabled = false; btn.textContent = 'Run gates'; }
}

// ── Generate + Run (Prompt Mode) ──
async function generateAndRun() {
  const btn = document.getElementById('generateRunBtn');
  const prompt = document.getElementById('promptInput').value.trim();
  const status = document.getElementById('prompt-status');
  if (!prompt) { status.textContent = 'Please enter a task description.'; return; }

  btn.disabled = true; btn.textContent = 'Generating...'; status.textContent = '';

  const modelSel = document.getElementById('ai-model-select');
  const model = modelSel && modelSel.value ? modelSel.value : undefined;

  try {
    // Step 1: Generate YAML
    const body = { prompt };
    if (model) body.model = model;
    const genResp = await fetch('/ai/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const genData = await safeJson(genResp);
    if (!genResp.ok) {
      status.textContent = 'Error: ' + (genData.detail || genResp.status);
      return;
    }

    // Step 2: Set YAML editor + show summary cards
    document.getElementById('yaml-input').value = genData.yaml;
    showSummaryCards(genData.yaml);
    const via = genData.provider === 'fallback' ? ' (fallback)' : ' via ' + (genData.model_used || '');
    status.textContent = 'Generated' + via + ' — running gates...';

    // Step 3: Run gates (skip auto-reload)
    btn.textContent = 'Running gates...';
    _skipReload = true;
    await submitRun();

    status.textContent = 'Done' + via + '.';
  } catch (e) {
    status.textContent = 'Network error: ' + e.message;
  } finally {
    btn.disabled = false; btn.textContent = 'Generate + Run';
  }
}

// ── Sweep ──
function _swVal(id) { const v = document.getElementById(id).value; return v === '' ? null : parseFloat(v); }

async function runSweep() {
  const btn = document.getElementById('sweep-btn');
  const status = document.getElementById('sweep-status');
  const summaryEl = document.getElementById('sweep-summary');
  const yamlText = document.getElementById('yaml-input').value;

  if (!yamlText.trim()) { status.textContent = 'Paste a TaskSpec YAML first.'; return; }

  btn.disabled = true; btn.textContent = 'Running sweep...'; status.textContent = '';
  summaryEl.className = 'sweep-summary';

  const variations = {};
  const massMin = _swVal('sw-mass-min'), massMax = _swVal('sw-mass-max');
  if (massMin !== null && massMax !== null) variations.mass_kg = { min: massMin, max: massMax };

  const txyz = {};
  const txMin = _swVal('sw-tx-min'), txMax = _swVal('sw-tx-max');
  if (txMin !== null && txMax !== null) txyz.x = { min: txMin, max: txMax };
  const tyMin = _swVal('sw-ty-min'), tyMax = _swVal('sw-ty-max');
  if (tyMin !== null && tyMax !== null) txyz.y = { min: tyMin, max: tyMax };
  const tzMin = _swVal('sw-tz-min'), tzMax = _swVal('sw-tz-max');
  if (tzMin !== null && tzMax !== null) txyz.z = { min: tzMin, max: tzMax };
  if (Object.keys(txyz).length) variations.target_xyz = txyz;

  try {
    const resp = await fetch('/sweeps', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        base_yaml: yamlText,
        variations: variations,
        n: parseInt(document.getElementById('sw-n').value) || 20,
        seed: parseInt(document.getElementById('sw-seed').value) || 1337,
      }),
    });
    const data = await safeJson(resp);
    if (!resp.ok) {
      status.textContent = 'Error: ' + (data.detail || resp.status);
      return;
    }

    summaryEl.className = 'sweep-summary show';
    const s = data.summary;
    document.getElementById('sweep-counts').innerHTML =
      '<span class="can-count">CAN: ' + s.CAN + '</span>' +
      '<span class="cant-count">HARD_CANT: ' + s.HARD_CANT + '</span>' +
      '<span style="color:var(--muted);">n=' + data.n + ' seed=' + data.seed + '</span>';

    const gates = Object.entries(s.by_failed_gate || {}).map(([g,c]) => g + ': ' + c).join(', ');
    document.getElementById('sweep-gates').textContent = gates ? 'By gate: ' + gates : '';
    document.getElementById('sweep-link').innerHTML = '<a href="/sweeps/' + data.sweep_id + '" target="_blank">View full sweep JSON</a>';

    const tbody = document.getElementById('sweep-runs');
    tbody.innerHTML = '';
    const show = data.runs.slice(0, 10);
    show.forEach(r => {
      const cls = r.verdict === 'CAN' ? 'can' : 'cant';
      tbody.innerHTML += '<tr><td><code>' + r.run_id + '</code></td>' +
        '<td><span class="badge ' + cls + '">' + r.verdict + '</span></td>' +
        '<td>' + (r.failed_gate || '-') + '</td>' +
        '<td><a href="' + r.evidence_url + '" target="_blank">evidence</a></td></tr>';
    });
    if (data.runs.length > 10) {
      tbody.innerHTML += '<tr><td colspan="4" style="color:var(--muted);text-align:center;">... and ' + (data.runs.length - 10) + ' more</td></tr>';
    }

    status.textContent = 'Sweep complete: ' + data.n + ' variants.';
  } catch (e) {
    status.textContent = 'Network error: ' + e.message;
  } finally {
    btn.disabled = false; btn.textContent = 'Run Sweep';
  }
}

// ── Keyboard shortcut: Ctrl+Enter in prompt textarea ──
document.getElementById('promptInput')?.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    generateAndRun();
  }
});
</script>
</body>
</html>
